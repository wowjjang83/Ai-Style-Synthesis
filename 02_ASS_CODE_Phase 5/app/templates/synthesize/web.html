<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Style Synthesis - 이미지 합성</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles */
        .upload-area { /* 단일 슬롯 내 업로드 영역 */
            border: 2px dashed #d1d5db; /* gray-300 */
            padding: 1rem; /* 패딩 약간 줄임 */
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s ease;
            min-height: 100px; /* 최소 높이 줄임 */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative; /* X 버튼 위치 기준 */
        }
        .upload-area:hover { background-color: #f9fafb; /* gray-50 */ }
        .upload-area.dragover { background-color: #f3f4f6; border-color: #9ca3af; /* gray-100, gray-400 */ }

        .item-slot { /* 각 아이템 슬롯 컨테이너 */
            border: 1px solid #e5e7eb; /* gray-200 */
            border-radius: 0.375rem; /* rounded-md */
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: white;
        }
        .preview-container { /* 미리보기 컨테이너 */
            position: relative;
            max-width: 100px; /* 미리보기 최대 너비 */
            margin: 0.5rem auto 0; /* 상하 마진, 좌우 자동 */
        }
        .preview-image { /* 미리보기 이미지 */
            max-height: 80px; /* 미리보기 최대 높이 */
            display: block;
            margin: auto;
            border-radius: 0.25rem; /* rounded-sm */
        }
        .remove-image-button { /* X 버튼 */
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: rgba(255, 0, 0, 0.7);
            color: white;
            border-radius: 50%;
            width: 1.25rem; /* w-5 */
            height: 1.25rem; /* h-5 */
            font-size: 0.75rem; /* text-xs */
            line-height: 1.25rem; /* 버튼 높이와 동일하게 */
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            border: 1px solid white;
        }
         .remove-image-button:hover { background-color: rgba(200, 0, 0, 0.8); }

        /* (기존 다른 스타일 유지) */
        #loading-indicator { display: none; }
        .spinner { /* ... */ }
        #result-image, #base-model-image { object-fit: cover; width: 100%; height: 100%; }
        .aspect-w-1.aspect-h-1 { position: relative; padding-bottom: 100%; }
        .aspect-w-1.aspect-h-1 > img { position: absolute; height: 100%; width: 100%; top: 0; right: 0; bottom: 0; left: 0; }
        #upload-error-message-area:not(.hidden) { display: block !important; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content img { max-width: 90vw; max-height: 85vh; object-fit: contain; }
    </style>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal">

    <div class="container mx-auto p-4 md:p-8 max-w-6xl">
        {# --- Header (변경 없음) --- #}
        <header class="mb-8 flex flex-wrap justify-between items-center gap-4">
            <a href="{{ url_for('synthesize.index') }}">
               <h1 class="text-3xl font-bold text-gray-800 hover:text-indigo-600">AI Style Synthesis</h1>
            </a>
            <div class="text-right">
                {% if session.get('user_id') %}
                <div id="user-info" class="text-sm text-gray-600 mb-1">...</div> {# 사용자 정보 표시 #}
                 <form action="{{ url_for('auth.logout') }}" method="POST" style="display: inline;">...</form> {# 로그아웃 버튼 #}
                 <a href="/admin/dashboard" id="admin-button" class="...">관리페이지</a> {# 관리자 버튼 #}
                {% else %}
                 <a href="{{ url_for('auth.login') }}" id="login-button" class="...">로그인</a> {# 로그인 버튼 #}
                 <a href="{{ url_for('auth.register') }}" id="register-button" class="...">회원가입</a> {# 회원가입 버튼 #}
                {% endif %}
            </div>
        </header>

        {# --- Flash Messages (변경 없음) --- #}
        {% with messages = get_flashed_messages(with_categories=true) %} ... {% endwith %}

        {# --- Main Grid --- #}
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

            {# --- Base Model Column (변경 없음) --- #}
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">기본 모델</h2>
                <div class="aspect-w-1 aspect-h-1 bg-gray-200 rounded-md overflow-hidden">
                    <img id="base-model-image" src="{{ base_model_image_url }}" alt="기본 모델" ...>
                </div>
                <p class="text-sm text-gray-500 mt-2 text-center">현재 적용되는 기본 모델입니다.</p>
            </div>

            {# --- Item Upload Column (수정됨: 다중 슬롯 UI) --- #}
            <div class="bg-white p-6 rounded-lg shadow-md flex flex-col">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">아이템 선택 (최대 5개)</h2>

                {# --- 아이템 슬롯 컨테이너 --- #}
                <div id="item-slots-container" class="space-y-4 mb-4 flex-grow overflow-y-auto" style="max-height: 400px;"> {# 스크롤 추가 #}
                    {# JavaScript로 슬롯 내용 생성 또는 아래 HTML 반복 #}
                    {% for i in range(5) %} {# 5개의 슬롯 생성 #}
                    <div class="item-slot" data-slot-id="{{ i }}">
                        <div class="flex items-center justify-between mb-2">
                            <label for="item-type-{{ i }}" class="block text-sm font-medium text-gray-700 mr-2">아이템 {{ i + 1 }} 종류:</label>
                            <select id="item-type-{{ i }}" name="item_type_{{ i }}" class="item-type-select mt-1 block w-full pl-3 pr-10 py-1 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                                <option value="">-- 선택 --</option>
                                <option value="top">상의</option>
                                <option value="bottom">하의</option>
                                <option value="shoes">신발</option>
                                <option value="bag">가방</option>
                                <option value="accessory">액세서리</option>
                                <option value="hair">헤어</option>
                                {# TODO: 다른 아이템 종류 추가 가능 #}
                            </select>
                        </div>
                        <div id="upload-area-{{ i }}" class="upload-area rounded-md" data-slot-id="{{ i }}">
                            <input type="file" id="item-image-upload-{{ i }}" name="item_image_{{ i }}" accept="image/png, image/jpeg, image/jpg" class="item-image-upload hidden" data-slot-id="{{ i }}">
                            <div id="upload-content-{{ i }}" class="upload-content"> {# 내용을 감싸는 div #}
                                <p id="upload-prompt-{{ i }}" class="upload-prompt text-xs text-gray-500">클릭 또는 드래그하여<br>이미지 업로드</p>
                                <div id="preview-container-{{ i }}" class="preview-container hidden">
                                    <img id="image-preview-{{ i }}" src="#" alt="미리보기" class="preview-image">
                                    <button class="remove-image-button" data-slot-id="{{ i }}">X</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {# --- 아이템 슬롯 컨테이너 끝 --- #}

                 {# 오류 메시지 표시 영역 #}
                 <div id="upload-error-message-area" class="mb-4 px-4 py-3 rounded relative bg-red-100 border border-red-400 text-red-700 hidden" role="alert">
                     <strong class="font-bold">오류:</strong>
                     <span id="upload-error-message-content" class="block sm:inline"></span>
                 </div>

                {# 합성하기 버튼 (변경 없음) #}
                <div class="mt-auto">
                    <button id="synthesize-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-md focus:outline-none focus:shadow-outline transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center" disabled>
                         <span class="button-text">합성하기</span>
                         <span class="loading-spinner hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white ml-2"></span>
                    </button>
                     <div id="loading-indicator" class="mt-2 text-center text-gray-600 hidden">
                        <p>이미지 합성 중...</p>
                    </div>
                </div>
            </div> {# --- End Item Upload Column --- #}

            {# --- Synthesis Result Column (변경 없음) --- #}
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">합성 결과</h2>
                <div class="aspect-w-1 aspect-h-1 bg-gray-200 rounded-md overflow-hidden">
                    <img id="result-image" src="..." alt="합성 결과" class="cursor-pointer ..." ...>
                </div>
                 <div id="result-actions" class="mt-4 text-center hidden">...</div> {# 다운로드 버튼 #}
                 <p id="result-placeholder" class="text-sm text-gray-500 mt-2 text-center">...</p> {# Placeholder #}
            </div>

        </div> {# --- End Main Grid --- #}

        {# --- 결과 이미지 모달 (변경 없음) --- #}
        <div id="result-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4" ...> ... </div>

    </div> {# --- End Container --- #}

    <script>
        // --- DOM Element References ---
        // ... (기존 요소들) ...
        const itemSlotsContainer = document.getElementById('item-slots-container'); // 슬롯 컨테이너 추가
        // --- (모달 관련 요소는 그대로) ---

        // --- 데이터 관리 ---
        // 각 슬롯의 상태를 저장할 배열 (파일 객체, 선택된 타입)
        let itemSlotsData = Array(5).fill(null).map(() => ({ file: null, type: '' }));

        // --- Constants (기존과 동일) ---
        const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
        const ALLOWED_MIME_TYPES = ['image/png', 'image/jpeg', 'image/jpg'];
        const defaultResultImageSrc = 'https://placehold.co/512x512/e0e0e0/999999?text=Result';

        // --- Functions ---
        function closeResultModal() { /* ... (기존 코드) ... */ }

        // --- 이벤트 처리 함수 (수정/추가 필요) ---

        // 파일 선택 처리 (이벤트 위임 방식 사용)
        function handleFileSelect(event) {
            const fileInput = event.target;
            if (!fileInput.classList.contains('item-image-upload')) return; // 해당 input인지 확인

            const slotId = parseInt(fileInput.dataset.slotId, 10);
            const file = fileInput.files[0];
            processSelectedFile(file, slotId);
        }

        // 드래그 앤 드롭 처리 (이벤트 위임 방식 사용)
        function handleDragOver(event) {
             if (event.target.closest('.upload-area')) {
                event.preventDefault();
                event.target.closest('.upload-area').classList.add('dragover');
             }
        }
        function handleDragLeave(event) {
             if (event.target.closest('.upload-area')) {
                event.preventDefault();
                event.target.closest('.upload-area').classList.remove('dragover');
             }
        }
        function handleDrop(event) {
            const uploadArea = event.target.closest('.upload-area');
             if (uploadArea) {
                event.preventDefault();
                uploadArea.classList.remove('dragover');
                const slotId = parseInt(uploadArea.dataset.slotId, 10);
                const file = event.dataTransfer.files[0];
                processSelectedFile(file, slotId);
            }
        }

        // 파일 처리 (슬롯 ID 인자 추가)
        function processSelectedFile(file, slotId, keepError = false) {
            hideError(); // 공통 오류 메시지 숨기기
            const fileInput = document.getElementById(`item-image-upload-${slotId}`);
            const previewContainer = document.getElementById(`preview-container-${slotId}`);
            const previewImage = document.getElementById(`image-preview-${slotId}`);
            const uploadPrompt = document.getElementById(`upload-prompt-${slotId}`);

            if (file) {
                console.log(`[Slot ${slotId}] File selected:`, file.name);
                // 유효성 검사
                if (!ALLOWED_MIME_TYPES.includes(file.type)) { showError(`Slot ${slotId+1}: 허용되지 않는 파일 형식입니다.`); removeImage(slotId, true); return; }
                if (file.size > MAX_FILE_SIZE) { showError(`Slot ${slotId+1}: 파일 크기가 너무 큽니다 (${MAX_FILE_SIZE / 1024 / 1024}MB 이하).`); removeImage(slotId, true); return; }

                // 미리보기 표시 및 데이터 저장
                displayPreview(file, slotId);
                itemSlotsData[slotId].file = file; // 파일 객체 저장
            } else {
                removeImage(slotId); // 파일 선택 취소 시 초기화
            }
            updateSynthesizeButtonState(); // 합성 버튼 상태 업데이트
        }

        // 미리보기 표시 (슬롯 ID 인자 추가)
        function displayPreview(file, slotId) {
            const previewContainer = document.getElementById(`preview-container-${slotId}`);
            const previewImage = document.getElementById(`image-preview-${slotId}`);
            const uploadPrompt = document.getElementById(`upload-prompt-${slotId}`);
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                previewContainer.classList.remove('hidden');
                uploadPrompt.classList.add('hidden');
            }
            reader.readAsDataURL(file);
        }

        // 이미지 제거 (슬롯 ID 인자 추가)
        function removeImage(slotId, keepError = false) {
            const fileInput = document.getElementById(`item-image-upload-${slotId}`);
            const previewContainer = document.getElementById(`preview-container-${slotId}`);
            const previewImage = document.getElementById(`image-preview-${slotId}`);
            const uploadPrompt = document.getElementById(`upload-prompt-${slotId}`);

            fileInput.value = ''; // 파일 입력 초기화
            previewImage.src = '#';
            previewContainer.classList.add('hidden');
            uploadPrompt.classList.remove('hidden');

            // 데이터 초기화 및 타입 선택 제한 해제
            const removedType = itemSlotsData[slotId].type;
            itemSlotsData[slotId] = { file: null, type: '' }; // 슬롯 데이터 리셋
            document.getElementById(`item-type-${slotId}`).value = ''; // 드롭다운 리셋
            updateTypeSelectionRestrictions(); // 타입 선택 제한 업데이트

            if (!keepError) { hideError(); }
            updateSynthesizeButtonState();
            console.log(`[Slot ${slotId}] Image removed.`);
        }

        // 아이템 타입 변경 처리 (이벤트 위임)
        function handleTypeChange(event) {
            const selectElement = event.target;
            if (!selectElement.classList.contains('item-type-select')) return;

            const slotId = parseInt(selectElement.id.split('-').pop(), 10);
            const newType = selectElement.value;

            // 데이터 업데이트
            const oldType = itemSlotsData[slotId].type;
            itemSlotsData[slotId].type = newType;

            console.log(`[Slot ${slotId}] Type changed from '${oldType}' to '${newType}'`);

            // 타입 선택 제한 업데이트
            updateTypeSelectionRestrictions();
            updateSynthesizeButtonState(); // 타입이 있어야 합성 가능하도록
        }

        // 타입 선택 제한 업데이트 함수
        function updateTypeSelectionRestrictions() {
            const selectedTypes = new Set(
                itemSlotsData.map(slot => slot.type).filter(type => type !== '')
            );

            document.querySelectorAll('.item-type-select').forEach((select, index) => {
                const currentSlotType = itemSlotsData[index].type;
                for (const option of select.options) {
                    if (option.value === '') continue; // '-- 선택 --' 옵션은 항상 활성화

                    // 다른 슬롯에서 이미 선택된 타입이고, 현재 슬롯에서 선택한 타입이 아니라면 비활성화
                    if (selectedTypes.has(option.value) && option.value !== currentSlotType) {
                        option.disabled = true;
                    } else {
                        option.disabled = false;
                    }
                }
            });
        }

        // 합성하기 버튼 상태 업데이트 (수정됨)
        function updateSynthesizeButtonState() {
            // 최소 1개 이상의 슬롯에 파일과 타입이 모두 선택되었는지 확인
            const canSynthesize = itemSlotsData.some(slot => slot.file && slot.type);
            let currentAttempts = parseInt(remainingAttemptsSpan.textContent);
            const hasAttempts = isNaN(currentAttempts) || currentAttempts > 0;

            synthesizeButton.disabled = !(canSynthesize && hasAttempts);

            if (!hasAttempts && !isNaN(currentAttempts)) {
                 buttonText.textContent = '횟수 초과';
            } else {
                 buttonText.textContent = '합성하기';
            }
        }

        // 합성 요청 처리 (수정됨 - 데이터 수집 부분)
        async function handleSynthesize() {
             hideError();
             const activeSlots = itemSlotsData.filter(slot => slot.file && slot.type);

             if (activeSlots.length === 0) {
                 showError("합성할 아이템 이미지와 종류를 하나 이상 선택해주세요.");
                 return;
             }
            if (synthesizeButton.disabled && !buttonText.textContent.includes('처리중')) { /* ... (횟수 초과 메시지) ... */ return; }

            setLoadingState(true);
            resultImage.src = 'https://placehold.co/512x512/e0e0e0/999999?text=Processing...';
            resultActions.classList.add('hidden'); resultPlaceholder.classList.remove('hidden'); resultPlaceholder.textContent = '이미지 합성 중...';

            // --- FormData 구성 (수정됨) ---
            const formData = new FormData();
            activeSlots.forEach((slot, index) => {
                // 백엔드에서 받을 이름 형식 정의 (예: item_image_0, item_type_0)
                formData.append(`item_image_${index}`, slot.file);
                formData.append(`item_type_${index}`, slot.type);
            });
            // 총 아이템 개수 정보 추가 (백엔드에서 반복 처리 시 유용)
            formData.append('item_count', activeSlots.length);

            console.log("Synthesizing with multiple items:", activeSlots.map(s => s.type));
            console.log("FormData entries:", Array.from(formData.entries())); // 전송될 데이터 확인 (개발용)

            // --- API 호출 및 결과 처리 (백엔드 수정 전까지는 실패할 것임) ---
            try {
                // TODO: 백엔드 API URL 및 로직 수정 필요
                // 현재 '/synthesize/web'은 단일 아이템만 처리 가능
                showError("백엔드에서 다중 아이템 처리가 아직 구현되지 않았습니다."); // 임시 메시지
                throw new Error("Backend multi-item support not implemented yet.");

                // --- 아래는 백엔드 구현 후 활성화할 코드 예시 ---
                /*
                const response = await fetch('/synthesize/web_multi', { // 새 엔드포인트 예시
                    method: 'POST',
                    body: formData,
                });
                const result = await response.json();
                if (!response.ok) { throw new Error(result.error || `HTTP error! status: ${response.status}`); }
                console.log("API Result:", result);
                 if (result.output_file_url) {
                     const finalImageUrl = result.output_file_url + '?t=' + new Date().getTime();
                     resultImage.src = finalImageUrl;
                     downloadLink.href = result.output_file_url;
                     resultActions.classList.remove('hidden'); resultPlaceholder.classList.add('hidden');
                     if (result.remaining_attempts !== undefined) {
                         remainingAttemptsSpan.textContent = result.remaining_attempts;
                         updateSynthesizeButtonState();
                     }
                 } else { throw new Error("합성 결과 URL을 받지 못했습니다."); }
                */
            } catch (error) {
                console.error('Synthesis Error:', error);
                showError(`합성 중 오류 발생: ${error.message}`);
                resultImage.src = 'https://placehold.co/512x512/ffdddd/cc0000?text=Failed';
                resultActions.classList.add('hidden'); resultPlaceholder.classList.remove('hidden'); resultPlaceholder.textContent = '합성에 실패했습니다.';
            } finally {
                setLoadingState(false);
            }
        }

        // --- 로딩 상태, 오류 메시지 함수 (기존과 동일) ---
        function setLoadingState(isLoading) { /* ... */ }
        function showError(message) { /* ... */ }
        function hideError() { /* ... */ }

        // --- 이벤트 리스너 연결 ---
        document.addEventListener('DOMContentLoaded', () => {
            // 파일 입력 변경 이벤트 (모든 슬롯)
            itemSlotsContainer.addEventListener('change', handleFileSelect);
            // 타입 변경 이벤트 (모든 슬롯)
            itemSlotsContainer.addEventListener('change', handleTypeChange);
            // 드래그 앤 드롭 이벤트 (모든 슬롯)
            itemSlotsContainer.addEventListener('dragover', handleDragOver);
            itemSlotsContainer.addEventListener('dragleave', handleDragLeave);
            itemSlotsContainer.addEventListener('drop', handleDrop);
            // 업로드 영역 클릭 이벤트 (모든 슬롯)
            itemSlotsContainer.addEventListener('click', (event) => {
                const uploadArea = event.target.closest('.upload-area');
                if (uploadArea) {
                    const slotId = uploadArea.dataset.slotId;
                    document.getElementById(`item-image-upload-${slotId}`).click();
                }
                 // 이미지 제거 버튼 클릭
                 if (event.target.classList.contains('remove-image-button')) {
                     const slotId = parseInt(event.target.dataset.slotId, 10);
                     removeImage(slotId);
                 }
            });

            // 모달 이벤트 리스너
            resultImage.addEventListener('click', () => { /* ... */ });
            closeResultModalButton.addEventListener('click', closeResultModal);
            resultModalOverlay.addEventListener('click', closeResultModal);

            // 초기 상태 업데이트
            updateSynthesizeButtonState();
            hideError();
            updateTypeSelectionRestrictions(); // 초기 타입 제한 설정
        });

    </script>

</body>
</html>